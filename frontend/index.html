<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Tracker Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .auth-card {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            margin-top: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin-left: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .btn-icon:hover {
            background-color: #f3f4f6;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .summary-card p {
            opacity: 0.9;
        }

        .debt-item, .contact-item, .transaction-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .debt-item.owe-from {
            border-left-color: #10b981;
        }

        .debt-item.owe-to {
            border-left-color: #ef4444;
        }

        .debt-amount, .transaction-amount {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .debt-amount.positive, .transaction-amount.positive {
            color: #10b981;
        }

        .debt-amount.negative, .transaction-amount.negative {
            color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tab-container {
            display: flex;
            margin-bottom: 24px;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 500;
        }

        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success {
            color: #10b981;
            background: #f0fdf4;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container" x-data="debtTracker()" x-init="init()">
        <div class="header">
            <h1>💰 Debt Tracker</h1>
            <p>Keep track of what you owe and what others owe you</p>
        </div>

        <!-- Authentication Section -->
        <div x-show="!isAuthenticated" class="auth-card card">
            <div class="tab-container">
                <div class="tab" :class="{ active: authMode === 'login' }" @click="authMode = 'login'">Login</div>
                <div class="tab" :class="{ active: authMode === 'register' }" @click="authMode = 'register'">Register</div>
            </div>

            <div x-show="error" class="error" x-text="error"></div>

            <form @submit.prevent="authMode === 'login' ? login() : register()">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" x-model="auth.email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" x-model="auth.password" required>
                </div>
                <div x-show="authMode === 'register'">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" x-model="auth.name">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" x-model="auth.phone">
                    </div>
                </div>
                <button type="submit" class="btn" :disabled="loading">
                    <span x-show="!loading" x-text="authMode === 'login' ? 'Login' : 'Register'"></span>
                    <span x-show="loading">Loading...</span>
                </button>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div x-show="isAuthenticated">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h3 x-text="'$' + summary.total_owed_to_others.toFixed(2)"></h3>
                    <p>You Owe Others</p>
                </div>
                <div class="summary-card">
                    <h3 x-text="'$' + summary.total_owed_from_others.toFixed(2)"></h3>
                    <p>Others Owe You</p>
                </div>
                <div class="summary-card">
                    <h3 x-text="'$' + Math.abs(summary.net_balance).toFixed(2)" 
                        :class="summary.net_balance >= 0 ? 'positive' : 'negative'"></h3>
                    <p x-text="summary.net_balance >= 0 ? 'Net Positive' : 'Net Negative'"></p>
                </div>
                <div class="summary-card">
                    <h3 x-text="summary.active_debts_count"></h3>
                    <p>Active Debts</p>
                </div>
            </div>

            <!-- Analytics Chart -->
            <div class="card">
                <h2 style="margin-bottom: 20px;">Financial Overview</h2>
                <div class="chart-container">
                    <canvas id="financialChart"></canvas>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Contacts Section -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Contacts</h2>
                        <div>
                            <button class="btn btn-small" @click="exportData('contacts')">Export</button>
                            <button class="btn btn-small" @click="showContactModal = true">Add Contact</button>
                        </div>
                    </div>
                    <div x-show="contacts.length === 0" class="loading">No contacts yet</div>
                    <template x-for="contact in contacts" :key="contact.id">
                        <div class="contact-item">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong x-text="contact.name"></strong>
                                    <div x-text="contact.phone || contact.email"></div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" @click="editContact(contact)" title="Edit">✏️</button>
                                    <button class="btn-icon" @click="deleteContact(contact.id)" title="Delete">🗑️</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Debts Section -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Active Debts</h2>
                        <div>
                            <button class="btn btn-small" @click="exportData('debts')">Export</button>
                            <button class="btn btn-small" @click="showDebtModal = true">Add Debt</button>
                        </div>
                    </div>
                    <div x-show="debts.length === 0" class="loading">No debts yet</div>
                    <template x-for="debt in debts" :key="debt.id">
                        <div class="debt-item" :class="debt.direction">
                            <div class="debt-amount" :class="debt.direction === 'owe_from' ? 'positive' : 'negative'">
                                <span x-text="debt.direction === 'owe_from' ? '+' : '-'"></span>$<span x-text="debt.amount.toFixed(2)"></span>
                            </div>
                            <div><strong x-text="debt.contact?.name"></strong></div>
                            <div x-text="debt.description"></div>
                            <small x-text="debt.direction === 'owe_from' ? 'They owe you' : 'You owe them'"></small>
                            <div class="item-actions">
                                <button class="btn-icon" @click="addTransaction(debt)" title="Add Transaction">💰</button>
                                <button class="btn-icon" @click="editDebt(debt)" title="Edit">✏️</button>
                                <button class="btn-icon" @click="settleDebt(debt.id)" title="Settle">✅</button>
                                <button class="btn-icon" @click="deleteDebt(debt.id)" title="Delete">🗑️</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Transactions Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Recent Transactions</h2>
                    <div>
                        <button class="btn btn-small" @click="exportData('transactions')">Export</button>
                        <button class="btn btn-small" @click="showTransactionModal = true">Add Transaction</button>
                    </div>
                </div>
                <div x-show="transactions.length === 0" class="loading">No transactions yet</div>
                <template x-for="transaction in transactions.slice(0, 10)" :key="transaction.id">
                    <div class="transaction-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="transaction-amount" :class="getTransactionClass(transaction.transaction_type)">
                                    <span x-text="getTransactionPrefix(transaction.transaction_type)"></span>$<span x-text="transaction.amount.toFixed(2)"></span>
                                </div>
                                <div><strong x-text="getTransactionDescription(transaction)"></strong></div>
                                <div x-text="transaction.description"></div>
                                <small x-text="formatDate(transaction.created_at)"></small>
                            </div>
                            <button class="btn-icon" @click="deleteTransaction(transaction.id)" title="Delete">🗑️</button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Logout Button -->
            <div class="card" style="text-align: center;">
                <button class="btn btn-secondary" @click="logout()">Logout</button>
            </div>
        </div>

        <!-- Contact Modal -->
        <div class="modal" :class="{ show: showContactModal }" @click.self="showContactModal = false">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">Add New Contact</h3>
                <div x-show="error" class="error" x-text="error"></div>
                <form @submit.prevent="createContact()">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" x-model="newContact.name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" x-model="newContact.phone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" x-model="newContact.email">
                    </div>
                    <button type="submit" class="btn" :disabled="loading">
                        <span x-show="!loading">Add Contact</span>
                        <span x-show="loading">Adding...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showContactModal = false">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Debt Modal -->
        <div class="modal" :class="{ show: showDebtModal }" @click.self="showDebtModal = false">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">Add New Debt</h3>
                <div x-show="error" class="error" x-text="error"></div>
                <form @submit.prevent="createDebt()">
                    <div class="form-group">
                        <label>Contact *</label>
                        <select x-model="newDebt.contact_id" required>
                            <option value="">Select a contact</option>
                            <template x-for="contact in contacts" :key="contact.id">
                                <option :value="contact.id" x-text="contact.name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" step="0.01" x-model="newDebt.amount" required>
                    </div>
                    <div class="form-group">
                        <label>Direction *</label>
                        <select x-model="newDebt.direction" required>
                            <option value="">Select direction</option>
                            <option value="owe_to">I owe them</option>
                            <option value="owe_from">They owe me</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" x-model="newDebt.description" placeholder="What's this debt for?">
                    </div>
                    <button type="submit" class="btn" :disabled="loading">
                        <span x-show="!loading">Add Debt</span>
                        <span x-show="loading">Adding...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showDebtModal = false">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Transaction Modal -->
        <div class="modal" :class="{ show: showTransactionModal }" @click.self="showTransactionModal = false">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;" x-text="selectedDebt ? `Add Transaction for ${selectedDebt.contact?.name}` : 'Add Transaction'"></h3>
                <div x-show="error" class="error" x-text="error"></div>
                <form @submit.prevent="createTransaction()">
                    <div class="form-group" x-show="!selectedDebt">
                        <label>Debt *</label>
                        <select x-model="newTransaction.debt_id" required>
                            <option value="">Select a debt</option>
                            <template x-for="debt in debts" :key="debt.id">
                                <option :value="debt.id" x-text="`${debt.contact?.name} - $${debt.amount}`"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" step="0.01" x-model="newTransaction.amount" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select x-model="newTransaction.transaction_type" required>
                            <option value="">Select type</option>
                            <option value="lent">I lent money</option>
                            <option value="borrowed">I borrowed money</option>
                            <option value="paid_back">I paid back</option>
                            <option value="received_back">I received payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" x-model="newTransaction.description" placeholder="What's this transaction for?">
                    </div>
                    <button type="submit" class="btn" :disabled="loading">
                        <span x-show="!loading">Add Transaction</span>
                        <span x-show="loading">Adding...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" @click="closeTransactionModal()">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Edit Contact Modal -->
        <div class="modal" :class="{ show: showEditContactModal }" @click.self="showEditContactModal = false">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">Edit Contact</h3>
                <div x-show="error" class="error" x-text="error"></div>
                <form @submit.prevent="updateContact()">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" x-model="editingContact.name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" x-model="editingContact.phone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" x-model="editingContact.email">
                    </div>
                    <button type="submit" class="btn" :disabled="loading">
                        <span x-show="!loading">Update Contact</span>
                        <span x-show="loading">Updating...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showEditContactModal = false">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Edit Debt Modal -->
        <div class="modal" :class="{ show: showEditDebtModal }" @click.self="showEditDebtModal = false">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px;">Edit Debt</h3>
                <div x-show="error" class="error" x-text="error"></div>
                <form @submit.prevent="updateDebt()">
                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" step="0.01" x-model="editingDebt.amount" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" x-model="editingDebt.description" placeholder="What's this debt for?">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select x-model="editingDebt.status">
                            <option value="active">Active</option>
                            <option value="settled">Settled</option>
                            <option value="removed">Removed</option>
                        </select>
                    </div>
                    <button type="submit" class="btn" :disabled="loading">
                        <span x-show="!loading">Update Debt</span>
                        <span x-show="loading">Updating...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" @click="showEditDebtModal = false">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" :class="{ show: notification.show, error: notification.type === 'error' }" x-text="notification.message"></div>
    </div>

    <script>
        function debtTracker() {
            return {
                // State
                isAuthenticated: false,
                authMode: 'login',
                loading: false,
                error: '',
                token: '',
                user: null,
                
                // Data
                contacts: [],
                debts: [],
                transactions: [],
                summary: {
                    total_owed_to_others: 0,
                    total_owed_from_others: 0,
                    net_balance: 0,
                    active_debts_count: 0,
                    contacts_with_debts: 0
                },

                // Forms
                auth: {
                    email: '',
                    password: '',
                    name: '',
                    phone: ''
                },
                newContact: {
                    name: '',
                    phone: '',
                    email: ''
                },
                newDebt: {
                    contact_id: '',
                    amount: '',
                    direction: '',
                    description: ''
                },
                newTransaction: {
                    debt_id: '',
                    amount: '',
                    transaction_type: '',
                    description: ''
                },
                editingContact: {},
                editingDebt: {},
                selectedDebt: null,

                // Modals
                showContactModal: false,
                showDebtModal: false,
                showTransactionModal: false,
                showEditContactModal: false,
                showEditDebtModal: false,

                // Notification
                notification: {
                    show: false,
                    message: '',
                    type: 'success'
                },

                // Chart
                chart: null,

                // API Base URL
                apiUrl: 'http://localhost:8080/api/v1',

                // Initialize
                init() {
                    const savedToken = localStorage.getItem('debt_tracker_token');
                    if (savedToken) {
                        this.token = savedToken;
                        this.checkAuth();
                    }
                },

                // API Helper
                async apiCall(endpoint, options = {}) {
                    const url = `${this.apiUrl}${endpoint}`;
                    const config = {
                        headers: {
                            'Content-Type': 'application/json',
                            ...(this.token && { 'Authorization': `Bearer ${this.token}` })
                        },
                        ...options
                    };

                    try {
                        const response = await fetch(url, config);
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'Something went wrong');
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('API Error:', error);
                        throw error;
                    }
                },

                // Authentication
                async login() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        const data = await this.apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({
                                email: this.auth.email,
                                password: this.auth.password
                            })
                        });
                        
                        this.token = data.token;
                        this.user = data.user;
                        this.isAuthenticated = true;
                        localStorage.setItem('debt_tracker_token', this.token);
                        
                        await this.loadDashboardData();
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async register() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        const data = await this.apiCall('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(this.auth)
                        });
                        
                        this.token = data.token;
                        this.user = data.user;
                        this.isAuthenticated = true;
                        localStorage.setItem('debt_tracker_token', this.token);
                        
                        await this.loadDashboardData();
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async checkAuth() {
                    try {
                        const data = await this.apiCall('/auth/me');
                        this.user = data;
                        this.isAuthenticated = true;
                        await this.loadDashboardData();
                    } catch (error) {
                        this.logout();
                    }
                },

                logout() {
                    this.isAuthenticated = false;
                    this.token = '';
                    this.user = null;
                    localStorage.removeItem('debt_tracker_token');
                    this.resetForms();
                },

                // Data Loading
                async loadDashboardData() {
                    await Promise.all([
                        this.loadContacts(),
                        this.loadDebts(),
                        this.loadTransactions(),
                        this.loadSummary()
                    ]);
                    this.updateChart();
                },

                async loadContacts() {
                    try {
                        this.contacts = await this.apiCall('/contacts');
                    } catch (error) {
                        console.error('Failed to load contacts:', error);
                    }
                },

                async loadDebts() {
                    try {
                        this.debts = await this.apiCall('/debts');
                    } catch (error) {
                        console.error('Failed to load debts:', error);
                    }
                },

                async loadTransactions() {
                    try {
                        this.transactions = await this.apiCall('/transactions');
                    } catch (error) {
                        console.error('Failed to load transactions:', error);
                    }
                },

                async loadSummary() {
                    try {
                        this.summary = await this.apiCall('/debts/summary');
                    } catch (error) {
                        console.error('Failed to load summary:', error);
                    }
                },

                // CRUD Operations
                async createContact() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        await this.apiCall('/contacts', {
                            method: 'POST',
                            body: JSON.stringify(this.newContact)
                        });
                        
                        this.showContactModal = false;
                        this.resetContactForm();
                        await this.loadContacts();
                        this.showNotification('Contact added successfully!');
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async createDebt() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        await this.apiCall('/debts', {
                            method: 'POST',
                            body: JSON.stringify({
                                ...this.newDebt,
                                contact_id: parseInt(this.newDebt.contact_id),
                                amount: parseFloat(this.newDebt.amount)
                            })
                        });
                        
                        this.showDebtModal = false;
                        this.resetDebtForm();
                        await Promise.all([
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Debt added successfully!');
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async createTransaction() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        // Determine which debt_id to use
                        const debtId = this.selectedDebt ? this.selectedDebt.id : parseInt(this.newTransaction.debt_id);
                        
                        if (!debtId) {
                            throw new Error('Please select a debt');
                        }

                        const transactionData = {
                            debt_id: debtId,
                            amount: parseFloat(this.newTransaction.amount),
                            transaction_type: this.newTransaction.transaction_type,
                            description: this.newTransaction.description || ''
                        };

                        console.log('Creating transaction:', transactionData); // Debug log

                        await this.apiCall('/transactions', {
                            method: 'POST',
                            body: JSON.stringify(transactionData)
                        });
                        
                        this.closeTransactionModal();
                        this.resetTransactionForm();
                        await Promise.all([
                            this.loadTransactions(),
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Transaction added successfully!');
                    } catch (error) {
                        console.error('Transaction creation error:', error); // Debug log
                        this.error = error.message;
                        this.showNotification('Failed to create transaction: ' + error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // Edit Operations
                editContact(contact) {
                    this.editingContact = { ...contact };
                    this.showEditContactModal = true;
                },

                async updateContact() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        await this.apiCall(`/contacts/${this.editingContact.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                name: this.editingContact.name,
                                phone: this.editingContact.phone,
                                email: this.editingContact.email
                            })
                        });
                        
                        this.showEditContactModal = false;
                        await this.loadContacts();
                        this.showNotification('Contact updated successfully!');
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                editDebt(debt) {
                    this.editingDebt = { ...debt };
                    this.showEditDebtModal = true;
                },

                async updateDebt() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        await this.apiCall(`/debts/${this.editingDebt.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                amount: parseFloat(this.editingDebt.amount),
                                description: this.editingDebt.description,
                                status: this.editingDebt.status
                            })
                        });
                        
                        this.showEditDebtModal = false;
                        await Promise.all([
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Debt updated successfully!');
                    } catch (error) {
                        this.error = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                // Delete Operations
                async deleteContact(contactId) {
                    if (!confirm('Are you sure you want to delete this contact? This will also remove all associated debts.')) return;
                    
                    try {
                        await this.apiCall(`/contacts/${contactId}`, { method: 'DELETE' });
                        await Promise.all([
                            this.loadContacts(),
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Contact deleted successfully!');
                    } catch (error) {
                        this.showNotification('Failed to delete contact: ' + error.message, 'error');
                    }
                },

                async deleteDebt(debtId) {
                    if (!confirm('Are you sure you want to delete this debt?')) return;
                    
                    try {
                        await this.apiCall(`/debts/${debtId}`, { method: 'DELETE' });
                        await Promise.all([
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Debt deleted successfully!');
                    } catch (error) {
                        this.showNotification('Failed to delete debt: ' + error.message, 'error');
                    }
                },

                async deleteTransaction(transactionId) {
                    if (!confirm('Are you sure you want to delete this transaction?')) return;
                    
                    try {
                        await this.apiCall(`/transactions/${transactionId}`, { method: 'DELETE' });
                        await Promise.all([
                            this.loadTransactions(),
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Transaction deleted successfully!');
                    } catch (error) {
                        this.showNotification('Failed to delete transaction: ' + error.message, 'error');
                    }
                },

                // Transaction and Settlement Operations
                addTransaction(debt) {
                    this.selectedDebt = debt;
                    this.newTransaction.debt_id = debt.id;
                    this.showTransactionModal = true;
                },

                closeTransactionModal() {
                    this.showTransactionModal = false;
                    this.selectedDebt = null;
                    this.error = '';
                    this.resetTransactionForm();
                },

                async settleDebt(debtId) {
                    if (!confirm('Are you sure you want to mark this debt as settled?')) return;
                    
                    try {
                        const debt = this.debts.find(d => d.id === debtId);
                        await this.apiCall(`/debts/${debtId}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                amount: debt.amount,
                                description: debt.description,
                                status: 'settled'
                            })
                        });
                        
                        await Promise.all([
                            this.loadDebts(),
                            this.loadSummary()
                        ]);
                        this.updateChart();
                        this.showNotification('Debt settled successfully!');
                    } catch (error) {
                        this.showNotification('Failed to settle debt', 'error');
                    }
                },

                // Helper Functions
                getTransactionClass(type) {
                    return ['paid_back', 'received_back'].includes(type) ? 'positive' : 'negative';
                },

                getTransactionPrefix(type) {
                    return ['paid_back', 'received_back'].includes(type) ? '+' : '-';
                },

                getTransactionDescription(transaction) {
                    const debt = this.debts.find(d => d.id === transaction.debt_id);
                    return debt ? debt.contact?.name : 'Unknown Contact';
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString();
                },

                // Notification System
                showNotification(message, type = 'success') {
                    this.notification.message = message;
                    this.notification.type = type;
                    this.notification.show = true;
                    
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },

                // Chart Update
                updateChart() {
                    const ctx = document.getElementById('financialChart');
                    if (!ctx) return;

                    if (this.chart) {
                        this.chart.destroy();
                    }

                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['You Owe', 'Others Owe You'],
                            datasets: [{
                                data: [this.summary.total_owed_to_others, this.summary.total_owed_from_others],
                                backgroundColor: ['#ef4444', '#10b981'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },

                // Data Export
                exportData(type) {
                    let data = [];
                    let filename = '';
                    
                    switch(type) {
                        case 'contacts':
                            data = this.contacts.map(c => ({
                                name: c.name,
                                phone: c.phone || '',
                                email: c.email || '',
                                created: this.formatDate(c.created_at)
                            }));
                            filename = 'contacts.csv';
                            break;
                        case 'debts':
                            data = this.debts.map(d => ({
                                contact: d.contact?.name || '',
                                amount: d.amount,
                                direction: d.direction,
                                status: d.status,
                                description: d.description || '',
                                created: this.formatDate(d.created_at)
                            }));
                            filename = 'debts.csv';
                            break;
                        case 'transactions':
                            data = this.transactions.map(t => ({
                                contact: this.getTransactionDescription(t),
                                amount: t.amount,
                                type: t.transaction_type,
                                description: t.description || '',
                                date: this.formatDate(t.created_at)
                            }));
                            filename = 'transactions.csv';
                            break;
                    }
                    
                    this.downloadCSV(data, filename);
                },

                downloadCSV(data, filename) {
                    if (data.length === 0) {
                        this.showNotification('No data to export', 'error');
                        return;
                    }
                    
                    const headers = Object.keys(data[0]);
                    const csvContent = [
                        headers.join(','),
                        ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    this.showNotification(`${filename} downloaded successfully!`);
                },

                // Form Helpers
                resetForms() {
                    this.resetAuthForm();
                    this.resetContactForm();
                    this.resetDebtForm();
                    this.resetTransactionForm();
                },

                resetAuthForm() {
                    this.auth = { email: '', password: '', name: '', phone: '' };
                },

                resetContactForm() {
                    this.newContact = { name: '', phone: '', email: '' };
                },

                resetDebtForm() {
                    this.newDebt = { contact_id: '', amount: '', direction: '', description: '' };
                },

                resetTransactionForm() {
                    this.newTransaction = { debt_id: '', amount: '', transaction_type: '', description: '' };
                }
            }
        }
    </script>
</body>
</html>